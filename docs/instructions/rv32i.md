# RV32I Base Integer Instruction Set

RV32I 命令セットの定義と動作について記述します。

## LUI (Load Upper Immediate)

LUI (load upper immediate) は U 形式の命令で、20 ビットの即値をレジスタの上位 20 ビットにロードし、下位 12 ビットを 0 で埋めます。

### 命令フォーマット
```
| 31      12 | 11  7 | 6    0 |
|:----------:|:-----:|:------:|
| imm[31:12] | rd    | opcode |
```
- **imm[31:12]**: 20ビットの即値
- **rd**: 書き込み先レジスタ
- **opcode**: `0110111`

### 動作

```
x[rd] = imm << 12
```

### 説明

LUI 命令は、32 ビット定数の上位 20 ビットを構築するために使用されます。AUIPC 命令と組み合わせることで、PC 相対のアドレスを生成したり、ADDI 命令と組み合わせることで任意の 32 ビット定数を生成したりできます。

## AUIPC (Add Upper Immediate to PC)

AUIPC (add upper immediate to pc) は U 形式の命令で、20 ビットの即値を上位 20 ビットに配置し、下位 12 ビットを 0 で埋めた 32 ビットの値を作成し、それを現在の PC に加算して結果をレジスタに格納します。

### 命令フォーマット
```
| 31      12 | 11  7 | 6    0 |
|:----------:|:-----:|:------:|
| imm[31:12] | rd    | opcode |
```
- **imm[31:12]**: 20ビットの即値
- **rd**: 書き込み先レジスタ
- **opcode**: `0010111`

### 動作

```
x[rd] = pc + (imm << 12)
```

### 説明

AUIPC 命令は、PC 相対のアドレスを生成するために使用されます。AUIPC の後に JALR やロード/ストア命令（ADDI 等のオフセットを伴うもの）を続けることで、現在の PC から ±2 GiB の範囲内にある任意のアドレスへアクセスしたり、制御を移したりすることが可能になります。

## JAL (Jump and Link)

JAL (jump and link) は J 形式の命令で、PC 相対のオフセットを用いてジャンプし、ジャンプ後の次の命令のアドレス (PC + 4) をレジスタに格納します。

### 命令フォーマット
```
| 31 | 30      21 | 20 | 19      12 | 11  7 | 6    0 |
|:--:|:----------:|:--:|:----------:|:-----:|:------:|
| i1 | imm[10:1]  | i2 | imm[19:12] | rd    | opcode |
```
- **imm**: 符号付き 21 ビットオフセット。以下のように再構成されます：
  - `imm[20]` = inst[31]
  - `imm[19:12]` = inst[19:12]
  - `imm[11]` = inst[20]
  - `imm[10:1]` = inst[30:21]
  - `imm[0]` = 0
- **rd**: 戻り先アドレス (PC + 4) を格納するレジスタ
- **opcode**: `1101111`

### 動作

```
x[rd] = pc + 4
pc = pc + imm
```

### 説明

JAL 命令は、符号付き 21 ビットのオフセットを使用して、現在の PC から ±1 MiB の範囲でジャンプします。標準的な関数呼び出しでは `rd` に `x1` (ra) を指定します。単なる無条件ジャンプとして使用する場合は、`rd` に `x0` を指定することで戻り先アドレスを破棄できます。

## JALR (Jump and Link Register)

JALR (jump and link register) は I 形式の命令で、レジスタの値と符号付き 12 ビットのオフセットを用いてジャンプし、ジャンプ後の次の命令のアドレス (PC + 4) をレジスタに格納します。

### 命令フォーマット
```
| 31          20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:--------------:|:--------:|:------:|:-----:|:------:|
| imm[11:0]      | rs1      | funct3 | rd    | opcode |
```
- **imm[11:0]**: 符号付き 12 ビットオフセット
- **rs1**: ベースアドレスを格納するソースレジスタ
- **rd**: 戻り先アドレス (PC + 4) を格納するレジスタ
- **opcode**: `1100111`
- **funct3**: `000`

### 動作

```
t = pc + 4
pc = (x[rs1] + imm) & ~1
x[rd] = t
```

### 説明

JALR 命令は、任意の 32 ビット絶対アドレスへのジャンプを可能にします。ターゲットアドレスは、レジスタ `rs1` の値に符号付き 12 ビットの `imm` を加算し、最下位ビットを 0 に設定することで得られます。

通常、JALR は JAL 命令による関数呼び出しからの復帰（`jalr x0, 0(x1)`）や、関数ポインタを用いた間接呼び出し、また AUIPC 命令と組み合わせて PC から ±2 GiB の範囲内にある任意のアドレスへのジャンプに使用されます。
