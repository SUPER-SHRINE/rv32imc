# RV32M 拡張命令

RV32M は、乗算 (Multiply) および除算 (Divide) に関する命令セットです。

## MUL (Multiply)

MUL (multiply) は R 形式の命令で、2 つのレジスタの値（32ビット符号付き整数）を乗算し、結果の下位 32 ビットをレジスタに格納します。

### 命令フォーマット
```
| 31      25 | 24    20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:----------:|:--------:|:--------:|:------:|:-----:|:------:|
| 0000001    | rs2      | rs1      | funct3 | rd    | opcode |
```
- **rs2**: ソースレジスタ 2
- **rs1**: ソースレジスタ 1
- **rd**: 書き込み先レジスタ
- **opcode**: `0110011`
- **funct3**: `000`
- **funct7**: `0000001`

### 動作

```
x[rd] = x[rs1] * x[rs2]
```

### 説明

MUL 命令は、レジスタ `rs1` と `rs2` の値を 32 ビット符号付き整数として乗算し、その結果の下位 32 ビットを `rd` に格納します。符号付きと符号なしの乗算で下位 32 ビットの結果は同じになるため、この命令は符号なし整数の乗算としても使用できます。

## MULH (Multiply High)

MULH (multiply high) は R 形式の命令で、2 つのレジスタの値（32ビット符号付き整数）を乗算し、結果の上位 32 ビットをレジスタに格納します。

### 命令フォーマット
```
| 31      25 | 24    20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:----------:|:--------:|:--------:|:------:|:-----:|:------:|
| 0000001    | rs2      | rs1      | funct3 | rd    | opcode |
```
- **rs2**: ソースレジスタ 2
- **rs1**: ソースレジスタ 1
- **rd**: 書き込み先レジスタ
- **opcode**: `0110011`
- **funct3**: `001`
- **funct7**: `0000001`

### 動作

```
x[rd] = (x[rs1] *s x[rs2]) >> 32
```

### 説明

MULH 命令は、レジスタ `rs1` と `rs2` の値を 32 ビット符号付き整数として乗算し、その 64 ビットの結果のうち上位 32 ビットを `rd` に格納します。

## MULHSU (Multiply High Signed/Unsigned)

MULHSU (multiply high signed/unsigned) は R 形式の命令で、符号付き整数 (`rs1`) と符号なし整数 (`rs2`) を乗算し、結果の上位 32 ビットをレジスタに格納します。

### 命令フォーマット
```
| 31      25 | 24    20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:----------:|:--------:|:--------:|:------:|:-----:|:------:|
| 0000001    | rs2      | rs1      | funct3 | rd    | opcode |
```
- **rs2**: ソースレジスタ 2 (符号なし)
- **rs1**: ソースレジスタ 1 (符号付き)
- **rd**: 書き込み先レジスタ
- **opcode**: `0110011`
- **funct3**: `010`
- **funct7**: `0000001`

### 動作

```
x[rd] = (x[rs1] *s x[rs2]) >> 32
```
※ `rs1` は符号付き、`rs2` は符号なしとして扱われます。

### 説明

MULHSU 命令は、レジスタ `rs1` を符号付き整数、`rs2` を符号なし整数として扱い、それらを乗算した 64 ビットの結果のうち上位 32 ビットを `rd` に格納します。

## MULHU (Multiply High Unsigned)

MULHU (multiply high unsigned) は R 形式の命令で、2 つのレジスタの値（32ビット符号なし整数）を乗算し、結果の上位 32 ビットをレジスタに格納します。

### 命令フォーマット
```
| 31      25 | 24    20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:----------:|:--------:|:--------:|:------:|:-----:|:------:|
| 0000001    | rs2      | rs1      | funct3 | rd    | opcode |
```
- **rs2**: ソースレジスタ 2
- **rs1**: ソースレジスタ 1
- **rd**: 書き込み先レジスタ
- **opcode**: `0110011`
- **funct3**: `011`
- **funct7**: `0000001`

### 動作

```
x[rd] = (x[rs1] *u x[rs2]) >> 32
```

### 説明

MULHU 命令は、レジスタ `rs1` と `rs2` の値を 32 ビット符号なし整数として乗算し、その 64 ビットの結果のうち上位 32 ビットを `rd` に格納します。

## DIV (Divide)

DIV (divide) は R 形式の命令で、2 つのレジスタの値（32ビット符号付き整数）の除算を行い、商をレジスタに格納します。

### 命令フォーマット
```
| 31      25 | 24    20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:----------:|:--------:|:--------:|:------:|:-----:|:------:|
| 0000001    | rs2      | rs1      | funct3 | rd    | opcode |
```
- **rs2**: 除数 (divisor)
- **rs1**: 被除数 (dividend)
- **rd**: 書き込み先レジスタ
- **opcode**: `0110011`
- **funct3**: `100`
- **funct7**: `0000001`

### 動作

```
if x[rs2] == 0:
    x[rd] = -1
elif x[rs1] == -2^31 and x[rs2] == -1:
    x[rd] = -2^31
else:
    x[rd] = x[rs1] /s x[rs2]
```

### 説明

DIV 命令は、レジスタ `rs1` を被除数、`rs2` を除数として符号付き整数の除算を行い、その商を `rd` に格納します。
ゼロ除算の場合、結果は `-1` となります。オーバーフロー（最小の負の数を `-1` で割る場合）の結果は、被除数（最小の負の数）と同じになります。

## DIVU (Divide Unsigned)

DIVU (divide unsigned) は R 形式の命令で、2 つのレジスタの値（32ビット符号なし整数）の除算を行い、商をレジスタに格納します。

### 命令フォーマット
```
| 31      25 | 24    20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:----------:|:--------:|:--------:|:------:|:-----:|:------:|
| 0000001    | rs2      | rs1      | funct3 | rd    | opcode |
```
- **rs2**: 除数 (divisor)
- **rs1**: 被除数 (dividend)
- **rd**: 書き込み先レジスタ
- **opcode**: `0110011`
- **funct3**: `101`
- **funct7**: `0000001`

### 動作

```
if x[rs2] == 0:
    x[rd] = 2^32 - 1
else:
    x[rd] = x[rs1] /u x[rs2]
```

### 説明

DIVU 命令は、レジスタ `rs1` を被除数、`rs2` を除数として符号なし整数の除算を行い、その商を `rd` に格納します。
ゼロ除算の場合、結果はすべてのビットが 1（`0xffffffff`）となります。

## REM (Remainder)

REM (remainder) は R 形式の命令で、2 つのレジスタの値（32ビット符号付き整数）の除算を行い、剰余（余り）をレジスタに格納します。

### 命令フォーマット
```
| 31      25 | 24    20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:----------:|:--------:|:--------:|:------:|:-----:|:------:|
| 0000001    | rs2      | rs1      | funct3 | rd    | opcode |
```
- **rs2**: 除数 (divisor)
- **rs1**: 被除数 (dividend)
- **rd**: 書き込み先レジスタ
- **opcode**: `0110011`
- **funct3**: `110`
- **funct7**: `0000001`

### 動作

```
if x[rs2] == 0:
    x[rd] = x[rs1]
elif x[rs1] == -2^31 and x[rs2] == -1:
    x[rd] = 0
else:
    x[rd] = x[rs1] %s x[rs2]
```

### 説明

REM 命令は、レジスタ `rs1` を被除数、`rs2` を除数として符号付き整数の除算を行い、その剰余を `rd` に格納します。
剰余の符号は被除数と同じになります。ゼロ除算の場合、結果は被除数 `rs1` と同じになります。オーバーフローの場合、結果は `0` となります。

