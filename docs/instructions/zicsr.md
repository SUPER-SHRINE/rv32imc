# Zicsr 拡張命令

RV32I 命令セットの定義と動作について記述します。


## CSRRW (Atomic Read/Write CSR)

CSRRW (Atomic Read/Write CSR) は、CSR の値をレジスタに読み出すと同時に、新しい値を CSR に書き込みます。

### 命令フォーマット
```
| 31          20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:--------------:|:--------:|:------:|:-----:|:------:|
| csr            | rs1      | 001    | rd    | 1110011|
```
- **csr**: 12ビットの CSR アドレス
- **rs1**: 書き込む値を保持するソースレジスタ
- **rd**: 元の値を格納するターゲットレジスタ
- **opcode**: `1110011` (SYSTEM)
- **funct3**: `001`

### 動作

```
t = CSRs[csr]
CSRs[csr] = x[rs1]
x[rd] = t
```

### 説明

CSRRW 命令は、指定された CSR の現在の値を `rd` に格納し、`rs1` の値をその CSR に書き込みます。
`rd` が `x0` の場合、CSR からの値の読み出しは行われず、副作用（読み出しによるステータスの変化など）も発生しません。

## CSRRS (Atomic Read and Set Bits in CSR)

CSRRS (Atomic Read and Set Bits in CSR) は、CSR の値をレジスタに読み出し、さらにレジスタの値で指定されたビットを CSR 内でセットします。

### 命令フォーマット
```
| 31          20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:--------------:|:--------:|:------:|:-----:|:------:|
| csr            | rs1      | 010    | rd    | 1110011|
```
- **csr**: 12ビットの CSR アドレス
- **rs1**: セットするビットマスクを保持するソースレジスタ
- **rd**: 元の値を格納するターゲットレジスタ
- **opcode**: `1110011` (SYSTEM)
- **funct3**: `010`

### 動作

```
t = CSRs[csr]
CSRs[csr] = t | x[rs1]
x[rd] = t
```

### 説明

CSRRS 命令は、指定された CSR の現在の値を `rd` に格納し、元の値と `rs1` の論理和 (OR) を CSR に書き込みます。
`rs1` が `x0` の場合、CSR への書き込みは行われません。これにより、副作用を発生させずに CSR の値を読み出すことができます。

## CSRRC (Atomic Read and Clear Bits in CSR)

CSRRC (Atomic Read and Clear Bits in CSR) は、CSR の値をレジスタに読み出し、さらにレジスタの値で指定されたビットを CSR 内でクリアします。

### 命令フォーマット
```
| 31          20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:--------------:|:--------:|:------:|:-----:|:------:|
| csr            | rs1      | 011    | rd    | 1110011|
```
- **csr**: 12ビットの CSR アドレス
- **rs1**: クリアするビットマスクを保持するソースレジスタ
- **rd**: 元の値を格納するターゲットレジスタ
- **opcode**: `1110011` (SYSTEM)
- **funct3**: `011`

### 動作

```
t = CSRs[csr]
CSRs[csr] = t & ~x[rs1]
x[rd] = t
```

### 説明

CSRRC 命令は、指定された CSR の現在の値を `rd` に格納し、元の値と `rs1` のビット反転との論理積 (AND NOT) を CSR に書き込みます。
`rs1` が `x0` の場合、CSR への書き込みは行われません。

## CSRRWI (Atomic Read/Write CSR Immediate)

CSRRWI は CSRRW の即値版で、レジスタの代わりに 5 ビットのゼロ拡張された即値を CSR に書き込みます。

### 命令フォーマット
```
| 31          20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:--------------:|:--------:|:------:|:-----:|:------:|
| csr            | uimm     | 101    | rd    | 1110011|
```
- **csr**: 12ビットの CSR アドレス
- **uimm**: 5ビットのゼロ拡張即値
- **rd**: 元の値を格納するターゲットレジスタ
- **opcode**: `1110011` (SYSTEM)
- **funct3**: `101`

### 動作

```
t = CSRs[csr]
CSRs[csr] = zero_extend(uimm)
x[rd] = t
```

### 説明

CSRRWI 命令は、指定された CSR の現在の値を `rd` に格納し、5 ビットの `uimm` をゼロ拡張した値をその CSR に書き込みます。
CSRRW と同様に、`rd` が `x0` の場合は読み出しが発生しません。

## CSRRSI (Atomic Read and Set Bits in CSR Immediate)

CSRRSI は CSRRS の即値版で、5 ビットの即値で指定されたビットを CSR 内でセットします。

### 命令フォーマット
```
| 31          20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:--------------:|:--------:|:------:|:-----:|:------:|
| csr            | uimm     | 110    | rd    | 1110011|
```
- **csr**: 12ビットの CSR アドレス
- **uimm**: 5ビットのゼロ拡張即値
- **rd**: 元の値を格納するターゲットレジスタ
- **opcode**: `1110011` (SYSTEM)
- **funct3**: `110`

### 動作

```
t = CSRs[csr]
CSRs[csr] = t | zero_extend(uimm)
x[rd] = t
```

### 説明

CSRRSI 命令は、指定された CSR の現在の値を `rd` に格納し、元の値とゼロ拡張された `uimm` との論理和 (OR) を CSR に書き込みます。
`uimm` が 0 の場合、CSR への書き込みは行われません。

## CSRRCI (Atomic Read and Clear Bits in CSR Immediate)

CSRRCI は CSRRC の即値版で、5 ビットの即値で指定されたビットを CSR 内でクリアします。

### 命令フォーマット
```
| 31          20 | 19    15 | 14  12 | 11  7 | 6    0 |
|:--------------:|:--------:|:------:|:-----:|:------:|
| csr            | uimm     | 111    | rd    | 1110011|
```
- **csr**: 12ビットの CSR アドレス
- **uimm**: 5ビットのゼロ拡張即値
- **rd**: 元の値を格納するターゲットレジスタ
- **opcode**: `1110011` (SYSTEM)
- **funct3**: `111`

### 動作

```
t = CSRs[csr]
CSRs[csr] = t & ~zero_extend(uimm)
x[rd] = t
```

### 説明

CSRRCI 命令は、指定された CSR の現在の値を `rd` に格納し、元の値とゼロ拡張された `uimm` のビット反転との論理積 (AND NOT) を CSR に書き込みます。
`uimm` が 0 の場合、CSR への書き込みは行われません。
