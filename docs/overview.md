# RV32IMC エミュレータ 開発スコープ概要

本プロジェクトは、いわゆる「ファンタジーコンソール」の基盤となる仮想CPUとして、RISC-V RV32IMC 命令セットアーキテクチャのエミュレータを Rust で実装することを目的としています。

## 開発目標

- ファンタジーコンソール上で動作する、高速かつ正確な RV32IMC エミュレータの提供。
- ホスト（Rust）側からの容易なメモリ・I/O 操作インターフェースの提供。
- 命令のデコード、実行、レジスタ管理のクリーンな実装。

## スコープ

### 1. 命令セット (ISA)
以下の命令セットをサポートします。

- **RV32I**: 基本整数命令セット（32ビット）。
- **M 拡張**: 乗算および除算命令。
- **C 拡張**: 圧縮命令（16ビット長命令によるコードサイズ削減）。

### 2. 特権アーキテクチャ (Privileged ISA)
- 最小限の CSR (Control and Status Registers) の実装。
- マシンモード (Machine Mode) のみを基本とし、必要に応じてユーザーモードを検討。
- タイマー割り込みやソフトウェア割り込みの基礎的なサポート。

### 3. メモリ・バス構成
- 32ビットアドレス空間。
- ファンタジーコンソールの VRAM、オーディオレジスタ、入力デバイス（コントローラー）をマッピングするための外部バスインターフェース。
- オプションとして、将来的に DMA によるメモリ転送サポートを追加できるようにする。

### 4. 実行エンジン
- インタプリタ方式による命令実行（フェッチ・デコード・実行のループ）。

## 非スコープ（現時点）

- 高度なパイプラインシミュレーション（サイクル正確なエミュレーション）。
- 動的バイナリ変換 (JIT)。
- 複雑な仮想メモリ (MMU / SV32) の完全なサポート。
- A (Atomic) 拡張、F/D (Floating-Point) 拡張。

## テスト戦略

エミュレータの正確性を担保するため、以下の3段階のテストを実施します。

### 1. 単体テスト (Unit Test)
- Rust の `#[test]` を利用し、個別の命令デコードおよび実行ロジックを検証します。
- 1ステップ実行ごとにレジスタやメモリの状態が期待通りに変化するかを確認します。

### 2. RISC-V Architecture Tests
- 公式のテストスイート ([riscv-tests](https://github.com/riscv-software-src/riscv-tests)) を利用し、ISA 仕様への準拠を確認します。
- 特定のメモリ領域（`tohost` 等）への書き込み値によって成功/失敗を判定します。

### 3. トレースログの比較 (Golden Log Comparison)
- 信頼性の高い既存エミュレータ（Spike, QEMU 等）と実行ログを比較します。
- 各ステップの PC、実行命令、レジスタ状態の差分を確認し、バグを特定します。

### デバッグ支援機能
テストおよび開発を円滑に進めるため、以下の機能を実装します。
- **レジスタダンプ**: 全レジスタの状態をコンソールに表示する機能。
- **トレース出力**: 実行した命令を逆アセンブル形式で逐次表示する機能。

基本的にデバッグ支援機能は `#[cfg(debug_assertions)]` マクロを使用し、リリースビルドに含めないようにする

## 将来的な展望

- WebAssembly へのコンパイルによるブラウザ上での動作。
- デバッグツールの提供（レジスタダンプ、逆アセンブラ、ブレークポイント）。
